(self.webpackChunk_contentweaver_cms=self.webpackChunk_contentweaver_cms||[]).push([[7948,9450],{17948:(g,u,s)=>{"use strict";s.d(u,{ProtectedCreateView:()=>cs});var t=s(58466),l=s(43348),d=s(34511),c=s(89142),R=s(19450),A=s(2730),x=s(50885),I=s(66451),o=s(91155),P=s(79412),T=s(9361),H=s(95052),Q=s(50682),L=s(20153),v=s(76024),E=s(85209),j=s(43900),y=s(69093),k=s(85041),$=s(3891),b=s(90588),V=s(49382),S=s(12762),os=s(19292),is=s(9174),ls=s(6056),_s=s(33854),ds=s(31075),X=s(19727),Es=s(8184),G=s(11001),rs=s(15778),ss=s(81806),As=s(95431),Ts=s(55688),hs=s(32962),ms=s(40060),gs=s(26208),ps=s(31666),Cs=s(69506),Is=s(3691),vs=s(2119),us=s(46705),Ls=s(59362),Rs=s(98907),ys=s(28685),Us=s(45946),Bs=s(6377),fs=s(71484),xs=s(97755),Ws=s(85960),Ks=s(25395),js=s(35771),Ss=s(36171),Ns=s(88479),ks=s(21376),$s=s(68122),Vs=s(70962),Gs=s(52771);const cs=()=>{const Ps=(0,d.d4)(c.s);return(0,t.jsx)(l.kz,{permissions:Ps.settings?.["api-tokens"].create,children:(0,t.jsx)(R.w,{})})}},19450:(g,u,s)=>{"use strict";s.d(u,{ProtectedEditView:()=>Et,w:()=>Os});var t=s(58466),l=s(2730),d=s(95811),c=s(49662),R=s(6814),A=s(45227),x=s(16113),I=s(15763),o=s(38973),P=s(12688),T=s(61680),H=s(18834),Q=s(15659),L=s(59979),v=s(13775),E=s(43348),j=s(85209),y=s(96508),k=s(77645),$=s(91155),b=s(36171),V=s(53237),S=s(88479),os=s(39418),is=s(81100),ls=s(84545),_s=s(21376),ds=s(68122),X=s(86784),Es=s(70962),G=s(69093),rs=s(94683),ss=s(52771),As=s(79412),Ts=s(9361),hs=s(95052),ms=s(50682),gs=s(20153),ps=s(76024),Cs=s(34511),Is=s(43900),vs=s(85041),us=s(3891),Ls=s(90588),Rs=s(49382),ys=s(12762),Us=s(19292),Bs=s(9174),fs=s(6056),xs=s(33854),Ws=s(31075),Ks=s(19727),js=s(8184),Ss=s(11001),Ns=s(15778),ks=s(81806),$s=s(95431),Vs=s(55688),Gs=s(32962),cs=s(40060),Ps=s(26208),ht=s(31666),mt=s(69506),gt=s(3691),pt=s(2119),Ct=s(46705),It=s(59362),vt=s(98907),ut=s(28685),Lt=s(45946),Rt=s(6377),yt=s(71484),Ut=s(97755),Bt=s(85960),ft=s(25395),xt=s(35771);const Fs=$.n.injectEndpoints({endpoints:n=>({getPermissions:n.query({query:()=>"/admin/content-api/permissions",transformResponse:e=>e.data}),getRoutes:n.query({query:()=>"/admin/content-api/routes",transformResponse:e=>e.data})}),overrideExisting:!1}),{useGetPermissionsQuery:Ys,useGetRoutesQuery:zs}=Fs,[Hs,Qs]=(0,os.q)("ApiTokenPermissionsContext"),Xs=({children:n,...e})=>(0,t.jsx)(Hs,{...e,children:n}),ts=()=>Qs("useApiTokenPermissions"),Zs=({errors:n={},onChange:e,canEditInputs:a,isCreating:r,values:i={},apiToken:O={},onDispatch:_,setHasChangedPermissions:K})=>{const{formatMessage:m}=(0,y.A)(),W=({target:{value:U}})=>{K(!1),U==="full-access"&&_({type:"SELECT_ALL_ACTIONS"}),U==="read-only"&&_({type:"ON_CHANGE_READ_ONLY"})},Z=[{value:"read-only",label:{id:"Settings.tokens.types.read-only",defaultMessage:"Read-only"}},{value:"full-access",label:{id:"Settings.tokens.types.full-access",defaultMessage:"Full access"}},{value:"custom",label:{id:"Settings.tokens.types.custom",defaultMessage:"Custom"}}];return(0,t.jsx)(A.a,{background:"neutral0",hasRadius:!0,shadow:"filterShadow",paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,children:(0,t.jsxs)(L.s,{direction:"column",alignItems:"stretch",gap:4,children:[(0,t.jsx)(v.o,{variant:"delta",as:"h2",children:m({id:"global.details",defaultMessage:"Details"})}),(0,t.jsxs)(o.x,{gap:5,children:[(0,t.jsx)(P.E,{col:6,xs:12,children:(0,t.jsx)(S.T,{error:n.name,value:i.name,canEditInputs:a,onChange:e})},"name"),(0,t.jsx)(P.E,{col:6,xs:12,children:(0,t.jsx)(S.a,{error:n.description,value:i.description,canEditInputs:a,onChange:e})},"description"),(0,t.jsx)(P.E,{col:6,xs:12,children:(0,t.jsx)(S.L,{isCreating:r,error:n.lifespan,value:i.lifespan,onChange:e,token:O})},"lifespan"),(0,t.jsx)(P.E,{col:6,xs:12,children:(0,t.jsx)(S.b,{value:i.type,error:n.type,label:{id:"Settings.tokens.form.type",defaultMessage:"Token type"},onChange:U=>{W({target:{value:U}}),e({target:{name:"type",value:U}})},options:Z,canEditInputs:a})},"type")]})]})})},Js=({apiTokenName:n=null})=>{const{formatMessage:e}=(0,y.A)();return(0,E.L4)(),(0,t.jsxs)(Q.g,{"aria-busy":"true",children:[(0,t.jsx)(E.x7,{name:"API Tokens"}),(0,t.jsx)(H.Q,{primaryAction:(0,t.jsx)(x.$,{disabled:!0,startIcon:(0,t.jsx)(is.A,{}),type:"button",size:"L",children:e({id:"global.save",defaultMessage:"Save"})}),title:n||e({id:"Settings.apiTokens.createPage.title",defaultMessage:"Create API Token"})}),(0,t.jsx)(T.s,{children:(0,t.jsx)(E.Bl,{})})]})},bs=n=>{switch(n){case"POST":return{text:"success600",border:"success200",background:"success100"};case"GET":return{text:"secondary600",border:"secondary200",background:"secondary100"};case"PUT":return{text:"warning600",border:"warning200",background:"warning100"};case"DELETE":return{text:"danger600",border:"danger200",background:"danger100"};default:return{text:"neutral600",border:"neutral200",background:"neutral100"}}},ws=(0,X.Ay)(A.a)`
  margin: -1px;
  border-radius: ${({theme:n})=>n.spaces[1]} 0 0 ${({theme:n})=>n.spaces[1]};
`,qs=({route:n={handler:"Nocontroller.error",method:"GET",path:"/there-is-no-path"}})=>{const{formatMessage:e}=(0,y.A)(),{method:a,handler:r,path:i}=n,O=i?ds(i.split("/")):[],[_="",K=""]=r?r.split("."):[],m=bs(n.method);return(0,t.jsxs)(L.s,{direction:"column",alignItems:"stretch",gap:2,children:[(0,t.jsxs)(v.o,{variant:"delta",as:"h3",children:[e({id:"Settings.apiTokens.createPage.BoundRoute.title",defaultMessage:"Bound route to"}),"\xA0",(0,t.jsx)("span",{children:_}),(0,t.jsxs)(v.o,{variant:"delta",textColor:"primary600",children:[".",K]})]}),(0,t.jsxs)(L.s,{hasRadius:!0,background:"neutral0",borderColor:"neutral200",gap:0,children:[(0,t.jsx)(ws,{background:m.background,borderColor:m.border,padding:2,children:(0,t.jsx)(v.o,{fontWeight:"bold",textColor:m.text,children:a})}),(0,t.jsx)(A.a,{paddingLeft:2,paddingRight:2,children:_s(O,W=>(0,t.jsxs)(v.o,{textColor:W.includes(":")?"neutral600":"neutral900",children:["/",W]},W))})]})]})},st=()=>{const{value:{selectedAction:n,routes:e}}=ts(),{formatMessage:a}=(0,y.A)(),r=n?.split(".")[0];return(0,t.jsx)(P.E,{col:5,background:"neutral150",paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,style:{minHeight:"100%"},children:n?(0,t.jsx)(L.s,{direction:"column",alignItems:"stretch",gap:2,children:r&&r in e&&e[r].map(i=>i.config.auth?.scope?.includes(n)||i.handler===n?(0,t.jsx)(qs,{route:i},i.handler):null)}):(0,t.jsxs)(L.s,{direction:"column",alignItems:"stretch",gap:2,children:[(0,t.jsx)(v.o,{variant:"delta",as:"h3",children:a({id:"Settings.apiTokens.createPage.permissions.header.title",defaultMessage:"Advanced settings"})}),(0,t.jsx)(v.o,{as:"p",textColor:"neutral600",children:a({id:"Settings.apiTokens.createPage.permissions.header.hint",defaultMessage:"Select the application's actions or the plugin's actions and click on the cog icon to display the bound route"})})]})})},Ms=(0,X.AH)`
  background: ${n=>n.theme.colors.primary100};
  svg {
    opacity: 1;
  }
`,tt=(0,X.Ay)(A.a)`
  display: flex;
  justify-content: space-between;
  align-items: center;

  svg {
    opacity: 0;
    path {
      fill: ${n=>n.theme.colors.primary600};
    }
  }

  /* Show active style both on hover and when the action is selected */
  ${n=>n.isActive&&Ms}
  &:hover {
    ${Ms}
  }
`,et=X.Ay.div`
  flex: 1;
  align-self: center;
  border-top: 1px solid ${({theme:n})=>n.colors.neutral150};
`,nt=({controllers:n=[],label:e,orderNumber:a=0,disabled:r=!1,onExpanded:i=()=>null,indexExpandendCollapsedContent:O=null})=>{const{value:{onChangeSelectAll:_,onChange:K,selectedActions:m,setSelectedAction:W,selectedAction:Z}}=ts(),[U,w]=l.useState(!1),{formatMessage:J}=(0,y.A)(),p=()=>{w(h=>!h),i(a)};l.useEffect(()=>{O!==null&&O!==a&&U&&w(!1)},[O,a,U]);const Ds=h=>h===Z;return(0,t.jsxs)(d.n,{expanded:U,onToggle:p,variant:a%2?"primary":"secondary",children:[(0,t.jsx)(R.P,{title:Es(e)}),(0,t.jsx)(c.u,{children:n?.map(h=>{const B=h.actions.every(C=>m.includes(C.actionId)),f=h.actions.some(C=>m.includes(C.actionId));return(0,t.jsxs)(A.a,{children:[(0,t.jsxs)(L.s,{justifyContent:"space-between",alignItems:"center",padding:4,children:[(0,t.jsx)(A.a,{paddingRight:4,children:(0,t.jsx)(v.o,{variant:"sigma",textColor:"neutral600",children:h?.controller})}),(0,t.jsx)(et,{}),(0,t.jsx)(A.a,{paddingLeft:4,children:(0,t.jsx)(I.S,{value:B,indeterminate:!B&&f,onValueChange:()=>{_({target:{value:[...h.actions]}})},disabled:r,children:J({id:"app.utils.select-all",defaultMessage:"Select all"})})})]}),(0,t.jsx)(o.x,{gap:4,padding:4,children:h?.actions&&h?.actions.map(C=>(0,t.jsx)(P.E,{col:6,children:(0,t.jsxs)(tt,{isActive:Ds(C.actionId),padding:2,hasRadius:!0,children:[(0,t.jsx)(I.S,{value:m.includes(C.actionId),name:C.actionId,onValueChange:()=>{K({target:{value:C.actionId}})},disabled:r,children:C.action}),(0,t.jsx)("button",{type:"button","data-testid":"action-cog",onClick:()=>W({target:{value:C.actionId}}),style:{display:"inline-flex",alignItems:"center"},children:(0,t.jsx)(ls.A,{})})]})},C.actionId))})]},`${e}.${h?.controller}`)})})]})},at=({section:n=null,...e})=>{const[a,r]=l.useState(null),i=O=>r(O);return(0,t.jsx)(A.a,{padding:4,background:"neutral0",children:n&&n.map((O,_)=>(0,t.jsx)(nt,{label:O.label,controllers:O.controllers,orderNumber:_,indexExpandendCollapsedContent:a,onExpanded:i,...e},O.apiId))})},ot=({...n})=>{const{value:{data:e}}=ts(),{formatMessage:a}=(0,y.A)();return(0,t.jsxs)(o.x,{gap:0,shadow:"filterShadow",hasRadius:!0,background:"neutral0",children:[(0,t.jsxs)(P.E,{col:7,paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,children:[(0,t.jsxs)(L.s,{direction:"column",alignItems:"stretch",gap:2,children:[(0,t.jsx)(v.o,{variant:"delta",as:"h2",children:a({id:"Settings.apiTokens.createPage.permissions.title",defaultMessage:"Permissions"})}),(0,t.jsx)(v.o,{as:"p",textColor:"neutral600",children:a({id:"Settings.apiTokens.createPage.permissions.description",defaultMessage:"Only actions bound by a route are listed below."})})]}),e?.permissions&&(0,t.jsx)(at,{section:e?.permissions,...n})]}),(0,t.jsx)(st,{})]})},it=G.Ik().shape({name:G.Yj().max(100).required(E.iW.required),type:G.Yj().oneOf(["read-only","full-access","custom"]).required(E.iW.required),description:G.Yj().nullable(),lifespan:G.ai().integer().min(0).nullable().defined(E.iW.required)}),lt=n=>{const e={allActionsIds:[],permissions:[]};return e.permissions=Object.entries(n).map(([a,r])=>({apiId:a,label:a.split("::")[1],controllers:Object.keys(r.controllers).map(i=>({controller:i,actions:i in r.controllers?r.controllers[i].map(O=>{const _=`${a}.${i}.${O}`;return a.includes("api::")&&e.allActionsIds.push(_),{action:O,actionId:_}}).flat():[]})).flat()})),e},_t={data:{allActionsIds:[],permissions:[]},routes:{},selectedAction:"",selectedActions:[]},dt=(n,e)=>(0,rs.Ay)(n,a=>{switch(e.type){case"ON_CHANGE":{a.selectedActions.includes(e.value)?ss(a.selectedActions,e.value):a.selectedActions.push(e.value);break}case"SELECT_ALL_IN_PERMISSION":{e.value.every(i=>a.selectedActions.includes(i.actionId))?e.value.forEach(i=>{ss(a.selectedActions,i.actionId)}):e.value.forEach(i=>{a.selectedActions.push(i.actionId)});break}case"SELECT_ALL_ACTIONS":{a.selectedActions=[...a.data.allActionsIds];break}case"ON_CHANGE_READ_ONLY":{const r=a.data.allActionsIds.filter(i=>i.includes("find")||i.includes("findOne"));a.selectedActions=[...r];break}case"UPDATE_PERMISSIONS_LAYOUT":{a.data=lt(e.value);break}case"UPDATE_ROUTES":{a.routes={...e.value};break}case"UPDATE_PERMISSIONS":{a.selectedActions=[...e.value];break}case"SET_SELECTED_ACTION":{a.selectedAction=e.value;break}default:return a}}),Os=()=>{(0,E.L4)();const{formatMessage:n}=(0,y.A)(),e=(0,E.hN)(),{lockApp:a,unlockApp:r}=(0,E.MA)(),{state:i}=(0,k.zy)(),O=(0,$.j)(M=>M.admin_app.permissions),[_,K]=l.useState(i?.apiToken?.accessKey?{...i.apiToken}:null),{trackUsage:m}=(0,E.z1)(),{setCurrentStep:W}=(0,E.Cx)(),{allowedActions:{canCreate:Z,canUpdate:U,canRegenerate:w}}=(0,E.ec)(O.settings?.["api-tokens"]),[J,p]=l.useReducer(dt,_t),h=(0,k.W5)("/settings/api-tokens/:id")?.params?.id,B=h==="create",{_unstableFormatAPIError:f,_unstableFormatValidationErrors:C}=(0,E.wq)(),rt=(0,k.W6)(),F=Ys(),Y=zs();l.useEffect(()=>{F.error&&e({type:"warning",message:f(F.error)})},[F.error,f,e]),l.useEffect(()=>{Y.error&&e({type:"warning",message:f(Y.error)})},[Y.error,f,e]),l.useEffect(()=>{F.data&&p({type:"UPDATE_PERMISSIONS_LAYOUT",value:F.data})},[F.data]),l.useEffect(()=>{Y.data&&p({type:"UPDATE_ROUTES",value:Y.data})},[Y.data]),l.useEffect(()=>{_&&(_.type==="read-only"&&p({type:"ON_CHANGE_READ_ONLY"}),_.type==="full-access"&&p({type:"SELECT_ALL_ACTIONS"}),_.type==="custom"&&p({type:"UPDATE_PERMISSIONS",value:_?.permissions}))},[_]),l.useEffect(()=>{m(B?"didAddTokenFromList":"didEditTokenFromList",{tokenType:V.A})},[B,m]);const{data:N,error:es,isLoading:ct}=(0,b.b)(h,{skip:!h||B||!!_});l.useEffect(()=>{es&&e({type:"warning",message:f(es)})},[es,f,e]),l.useEffect(()=>{N&&(K(N),N.type==="read-only"&&p({type:"ON_CHANGE_READ_ONLY"}),N.type==="full-access"&&p({type:"SELECT_ALL_ACTIONS"}),N.type==="custom"&&p({type:"UPDATE_PERMISSIONS",value:N?.permissions}))},[N]);const[Pt]=(0,b.c)(),[Mt]=(0,b.d)(),Ot=async(M,z)=>{m(B?"willCreateToken":"willEditToken",{tokenType:V.A}),a();try{if(B){const D=await Pt({...M,lifespan:M?.lifespan||null,permissions:M.type==="custom"?J.selectedActions:null});if("error"in D){(0,$.x)(D.error)&&D.error.name==="ValidationError"?z.setErrors(C(D.error)):e({type:"warning",message:f(D.error)});return}e({type:"success",message:n({id:"notification.success.apitokencreated",defaultMessage:"API Token successfully created"})}),m("didCreateToken",{type:D.data.type,tokenType:V.A}),rt.replace(`/settings/api-tokens/${D.data.id}`,{apiToken:D.data}),W("apiTokens.success")}else{const D=await Mt({id:h,name:M.name,description:M.description,type:M.type,permissions:M.type==="custom"?J.selectedActions:null});if("error"in D){(0,$.x)(D.error)&&D.error.name==="ValidationError"?z.setErrors(C(D.error)):e({type:"warning",message:f(D.error)});return}e({type:"success",message:n({id:"notification.success.apitokenedited",defaultMessage:"API Token successfully edited"})}),m("didEditToken",{type:D.data.type,tokenType:V.A})}}catch{e({type:"warning",message:{id:"notification.error",defaultMessage:"Something went wrong"}})}finally{r()}},[Dt,ns]=l.useState(!1),At={...J,onChange:({target:{value:M}})=>{ns(!0),p({type:"ON_CHANGE",value:M})},onChangeSelectAll:({target:{value:M}})=>{ns(!0),p({type:"SELECT_ALL_IN_PERMISSION",value:M})},setSelectedAction:({target:{value:M}})=>{p({type:"SET_SELECTED_ACTION",value:M})}},as=U&&!B||Z&&B;return ct?(0,t.jsx)(Js,{apiTokenName:_?.name}):(0,t.jsx)(Xs,{value:At,children:(0,t.jsxs)(Q.g,{children:[(0,t.jsx)(E.x7,{name:"API Tokens"}),(0,t.jsx)(j.l1,{validationSchema:it,validateOnChange:!1,initialValues:{name:_?.name||"",description:_?.description||"",type:_?.type,lifespan:_?.lifespan},enableReinitialize:!0,onSubmit:(M,z)=>Ot(M,z),children:({errors:M,handleChange:z,isSubmitting:D,values:q,setFieldValue:Tt})=>(Dt&&q?.type!=="custom"&&Tt("type","custom"),(0,t.jsxs)(E.lV,{children:[(0,t.jsx)(S.F,{backUrl:"/settings/api-tokens",title:{id:"Settings.apiTokens.createPage.title",defaultMessage:"Create API Token"},token:_,setToken:K,canEditInputs:as,canRegenerate:w,isSubmitting:D,regenerateUrl:"/admin/api-tokens/"}),(0,t.jsx)(T.s,{children:(0,t.jsxs)(L.s,{direction:"column",alignItems:"stretch",gap:6,children:[Boolean(_?.name)&&(0,t.jsx)(S.c,{token:_?.accessKey,tokenType:V.A}),(0,t.jsx)(Zs,{errors:M,onChange:z,canEditInputs:as,isCreating:B,values:q,apiToken:_,onDispatch:p,setHasChangedPermissions:ns}),(0,t.jsx)(ot,{disabled:!as||q?.type==="read-only"||q?.type==="full-access"})]})})]}))})]})})},Et=()=>{const n=(0,$.j)(e=>e.admin_app.permissions.settings?.["api-tokens"].read);return(0,t.jsx)(E.kz,{permissions:n,children:(0,t.jsx)(Os,{})})}},19842:(g,u,s)=>{var t=s(49638),l=s(49405),d=s(92753),c=s(82867),R=s(77165),A=Array.prototype,x=A.splice;function I(o,P,T,H){var Q=H?d:l,L=-1,v=P.length,E=o;for(o===P&&(P=R(P)),T&&(E=t(o,c(T)));++L<v;)for(var j=0,y=P[L],k=T?T(y):y;(j=Q(E,k,j,H))>-1;)E!==o&&x.call(E,j,1),x.call(o,j,1);return o}g.exports=I},21376:(g,u,s)=>{var t=s(49638),l=s(90355),d=s(29614),c=s(35771);function R(A,x){var I=c(A)?t:d;return I(A,l(x,3))}g.exports=R},36171:(g,u,s)=>{"use strict";s.d(u,{a:()=>A,b:()=>c,c:()=>R,d:()=>x,u:()=>d});var t=s(91155);const l=t.n.injectEndpoints({endpoints:I=>({getAPITokens:I.query({query:()=>"/admin/api-tokens",transformResponse:o=>o.data,providesTags:(o,P)=>[...o?.map(({id:T})=>({type:"ApiToken",id:T}))??[],{type:"ApiToken",id:"LIST"}]}),getAPIToken:I.query({query:o=>`/admin/api-tokens/${o}`,transformResponse:o=>o.data,providesTags:(o,P,T)=>[{type:"ApiToken",id:T}]}),createAPIToken:I.mutation({query:o=>({url:"/admin/api-tokens",method:"POST",data:o}),transformResponse:o=>o.data,invalidatesTags:[{type:"ApiToken",id:"LIST"}]}),deleteAPIToken:I.mutation({query:o=>({url:`/admin/api-tokens/${o}`,method:"DELETE"}),transformResponse:o=>o.data,invalidatesTags:(o,P,T)=>[{type:"ApiToken",id:T}]}),updateAPIToken:I.mutation({query:({id:o,...P})=>({url:`/admin/api-tokens/${o}`,method:"PUT",data:P}),transformResponse:o=>o.data,invalidatesTags:(o,P,{id:T})=>[{type:"ApiToken",id:T}]})}),overrideExisting:!1}),{useGetAPITokensQuery:d,useGetAPITokenQuery:c,useCreateAPITokenMutation:R,useDeleteAPITokenMutation:A,useUpdateAPITokenMutation:x}=l},52771:(g,u,s)=>{var t=s(70264),l=s(95980),d=t(l);g.exports=d},68122:(g,u,s)=>{var t=s(76158);function l(d){var c=d==null?0:d.length;return c?t(d,1,c):[]}g.exports=l},92753:g=>{function u(s,t,l,d){for(var c=l-1,R=s.length;++c<R;)if(d(s[c],t))return c;return-1}g.exports=u},95980:(g,u,s)=>{var t=s(19842);function l(d,c){return d&&d.length&&c&&c.length?t(d,c):d}g.exports=l}}]);
