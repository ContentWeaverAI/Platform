"use strict";(self.webpackChunk_contentweaver_cms=self.webpackChunk_contentweaver_cms||[]).push([[1039],{51039:(hs,G,s)=>{s.d(G,{ReviewWorkflowsEditPage:()=>ls});var t=s(58466),_=s(2730),J=s(16113),Z=s(59754),T=s(59979),C=s(13775),M=s(43348),b=s(81100),A=s(85209),q=s(96508),i=s(34511),ss=s(77645),ts=s(13635),os=s(37724),e=s(94313),es=s(89142),S=s(91155),ns=s(16141),h=s(77297),E=s(54314),W=s(34778),as=s(50552),cs=s(64820),Ls=s(9174),Ts=s(12762),Cs=s(69093),As=s(50885),Ws=s(66451),Rs=s(49382),Is=s(11001),Bs=s(79412),Us=s(9361),Ks=s(95052),ys=s(50682),us=s(20153),ws=s(76024),js=s(43900),Ss=s(85041),xs=s(3891),ps=s(90588),Fs=s(19292),ks=s(6056),zs=s(33854),Ns=s(31075),Vs=s(19727),Ys=s(8184),Qs=s(15778),Hs=s(81806),Xs=s(95431),$s=s(55688),Gs=s(32962),Js=s(40060),Zs=s(26208),bs=s(31666),qs=s(69506),st=s(3691),tt=s(2119),ot=s(46705),et=s(59362),nt=s(98907),at=s(28685),lt=s(45946),it=s(6377),_t=s(71484),rt=s(97755),Et=s(85960),dt=s(25395),Mt=s(35771);const ls=()=>{const{workflowId:R}=(0,ss.g)(),is=(0,i.d4)(es.s),{formatMessage:n}=(0,q.A)(),r=(0,i.wA)(),{_unstableFormatAPIError:_s,_unstableFormatValidationErrors:rs}=(0,M.wq)(),D=(0,M.hN)(),{isLoading:P,meta:O,workflows:g}=(0,as.u)(),{collectionTypes:x,singleTypes:p,isLoading:I}=(0,os.u)(),Es=(0,i.d4)(e.j),ds=(0,i.d4)(e.a),a=(0,i.d4)(e.b),F=(0,i.d4)(e.k),k=(0,i.d4)(e.c),v=(0,i.d4)(e.s),{allowedActions:{canDelete:Ms,canUpdate:B}}=(0,M.ec)(is.settings?.["review-workflows"]),[c,L]=_.useState({}),{getFeature:Ds,isLoading:z}=(0,S.m)(),{isLoading:U,roles:N}=(0,ts.u)(void 0),[V,d]=_.useState(null),[Ps,Y]=_.useState(),[Os,Q]=_.useState(!1),K=g?.find(o=>o.id===parseInt(R,10)),H=g?.filter(o=>o.id!==parseInt(R,10)).flatMap(o=>o.contentTypes),y=Ds("review-workflows"),f=y?.[W.C],m=y?.[W.a],[gs]=(0,ns.e)(),X=async()=>{Y(void 0),Q(!0);try{const o=await gs({id:R,data:{...a,stages:a.stages?.map(l=>{let $=!0;const w=Es.workflow?.stages?.find(j=>j.id===l?.id);return w&&($=w.permissions?.length!==l.permissions?.length||!w.permissions?.every(j=>!!l.permissions?.find(ms=>ms.role===j.role))),{...l,permissions:$?l.permissions:void 0}})}});if("error"in o){(0,S.x)(o.error)&&o.error.name==="ValidationError"&&Y(rs(o.error)),D({type:"warning",message:_s(o.error)});return}D({type:"success",message:{id:"notification.success.saved",defaultMessage:"Saved"}})}catch{D({type:"warning",message:{id:"notification.error",defaultMessage:"An error occurred"}})}finally{Q(!1)}L({})},vs=async()=>{await X()},fs=()=>{L({})},u=(0,A.Wx)({enableReinitialize:!0,initialErrors:Ps,initialValues:a,async onSubmit(){const o=a.contentTypes?.some(l=>H?.includes(l));O&&f&&O?.workflowCount>parseInt(f,10)?d("workflow"):a.stages&&m&&a.stages.length>parseInt(m,10)?d("stage"):F||o?(F&&L(l=>({...l,hasDeletedServerStages:!0})),o&&L(l=>({...l,hasReassignedContentTypes:!0}))):X()},validate(o){return(0,e.v)({values:o,formatMessage:n})}});return(0,e.u)(W.R,e.i),_.useEffect(()=>(!P&&K&&g&&(r((0,e.l)({workflow:K})),r((0,e.d)({workflows:g}))),I||r((0,e.e)({collectionTypes:x,singleTypes:p})),U||r((0,e.f)(N)),r((0,e.g)(P||I||U)),()=>{r((0,e.r)())}),[x,r,I,P,U,N,p,K,g]),_.useEffect(()=>{!P&&!z&&(O&&f&&O?.workflowCount>parseInt(f,10)?d("workflow"):a.stages&&m&&a.stages.length>parseInt(m,10)&&d("stage"))},[a.stages,z,P,y,O,f,m]),_.useEffect(()=>{!v&&k?.length===0&&D({blockTransition:!0,type:"warning",message:n({id:"Settings.review-workflows.stage.permissions.noPermissions.description",defaultMessage:"You don\u2019t have the permission to see roles"})})},[n,v,k,D]),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(h.D,{}),(0,t.jsx)(A.QI,{value:u,children:(0,t.jsxs)(A.lV,{onSubmit:u.handleSubmit,children:[(0,t.jsx)(h.H,{navigationAction:(0,t.jsx)(h.B,{href:"/settings/review-workflows"}),primaryAction:B&&(0,t.jsx)(J.$,{startIcon:(0,t.jsx)(b.A,{}),type:"submit",size:"M",disabled:!ds,loading:!Boolean(Object.keys(c).length>0)&&Os,children:n({id:"global.save",defaultMessage:"Save"})}),subtitle:!v&&n({id:"Settings.review-workflows.page.subtitle",defaultMessage:"{count, plural, one {# stage} other {# stages}}"},{count:a.stages?.length}),title:a.name||""}),(0,t.jsx)(h.R,{children:v?(0,t.jsx)(T.s,{justifyContent:"center",children:(0,t.jsx)(Z.a,{children:n({id:"Settings.review-workflows.page.isLoading",defaultMessage:"Workflow is loading"})})}):(0,t.jsxs)(T.s,{alignItems:"stretch",direction:"column",gap:7,children:[(0,t.jsx)(e.W,{canUpdate:B}),(0,t.jsx)(e.S,{canDelete:Ms,canUpdate:B,stages:u.values?.stages})]})})]})}),(0,t.jsx)(M.TM.Root,{isConfirmButtonLoading:v,isOpen:Object.keys(c).length>0,onToggleDialog:fs,onConfirm:vs,children:(0,t.jsx)(M.TM.Body,{children:(0,t.jsxs)(T.s,{direction:"column",gap:5,children:[c.hasDeletedServerStages&&(0,t.jsx)(C.o,{textAlign:"center",variant:"omega",children:n({id:"Settings.review-workflows.page.delete.confirm.stages.body",defaultMessage:"All entries assigned to deleted stages will be moved to the previous stage."})}),c.hasReassignedContentTypes&&(0,t.jsx)(C.o,{textAlign:"center",variant:"omega",children:n({id:"Settings.review-workflows.page.delete.confirm.contentType.body",defaultMessage:"{count} {count, plural, one {content-type} other {content-types}} {count, plural, one {is} other {are}} already mapped to {count, plural, one {another workflow} other {other workflows}}. If you save changes, {count, plural, one {this} other {these}} {count, plural, one {content-type} other {{count} content-types}} will no more be mapped to the {count, plural, one {another workflow} other {other workflows}} and all corresponding information will be removed."},{count:H?.filter(o=>a.contentTypes?.includes(o)).length})}),(0,t.jsx)(C.o,{textAlign:"center",variant:"omega",children:n({id:"Settings.review-workflows.page.delete.confirm.confirm",defaultMessage:"Are you sure you want to save?"})})]})})}),(0,t.jsxs)(E.L.Root,{isOpen:V==="workflow",onClose:()=>d(null),children:[(0,t.jsx)(E.L.Title,{children:n({id:"Settings.review-workflows.edit.page.workflows.limit.title",defaultMessage:"You\u2019ve reached the limit of workflows in your plan"})}),(0,t.jsx)(E.L.Body,{children:n({id:"Settings.review-workflows.edit.page.workflows.limit.body",defaultMessage:"Delete a workflow or contact Sales to enable more workflows."})})]}),(0,t.jsxs)(E.L.Root,{isOpen:V==="stage",onClose:()=>d(null),children:[(0,t.jsx)(E.L.Title,{children:n({id:"Settings.review-workflows.edit.page.stages.limit.title",defaultMessage:"You have reached the limit of stages for this workflow in your plan"})}),(0,t.jsx)(E.L.Body,{children:n({id:"Settings.review-workflows.edit.page.stages.limit.body",defaultMessage:"Try deleting some stages or contact Sales to enable more stages."})})]})]})}}}]);
